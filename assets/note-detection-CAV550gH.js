import{A as C,N as w}from"./Navigation-CtlIXiNf.js";import{f as b}from"./PitchUtils-Dm8PaPCI.js";import{c as I,s as D,a as y,b as x}from"./AudioResourceManager-DnsOnIC-.js";const g={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11};class S{constructor(t="geometry-scope-canvas"){this.canvas=typeof document<"u"?document.getElementById(t):null,this.ctx=this.canvas?this.canvas.getContext("2d"):null,this.animationId=null,this.notePayload=null,this.chordPayload=null,this.lastTimestamp=0,this.baseColors=["#00fff2","#ff00f7","#ffe066"],this.gridColor="rgba(255, 255, 255, 0.12)",this.fadeAmount=.05,this.ctx&&(this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas()))}resizeCanvas(){if(!this.canvas)return;const t=Math.min(this.canvas.clientWidth||360,420);this.canvas.width=t,this.canvas.height=t}updateFromNote(t){this.notePayload={...t,timestamp:typeof performance<"u"?performance.now():Date.now()},this.chordPayload=t.chord?t:this.chordPayload,this.start()}clear(){this.notePayload=null,this.chordPayload=null,this.ctx&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}start(){if(!this.ctx||this.animationId)return;const t=()=>{this.drawFrame(),this.animationId=requestAnimationFrame(t)};this.animationId=requestAnimationFrame(t)}stop(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}dispose(){this.stop(),this.clear(),this.canvas&&this.canvas.getContext("2d")?.clearRect(0,0,this.canvas.width,this.canvas.height)}drawFrame(){if(!this.ctx)return;const t=this.ctx,{width:e,height:i}=this.canvas;t.clearRect(0,0,e,i),t.save(),t.translate(e/2,i/2);const n=Math.min(e,i)/2-10;this.drawRadialGrid(t,n),this.drawBaseDodecagon(t,n*.9),this.chordPayload&&this.drawChord(t,n*.7,this.chordPayload),this.notePayload&&this.drawNoteVector(t,n,this.notePayload),t.restore()}drawRadialGrid(t,e){t.save(),t.strokeStyle=this.gridColor,t.lineWidth=1;for(let i=1;i<=4;i++)t.beginPath(),t.arc(0,0,e/4*i,0,Math.PI*2),t.stroke();t.restore()}drawBaseDodecagon(t,e){t.save(),t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=1,t.beginPath();for(let i=0;i<12;i++){const n=Math.PI*2*i/12-Math.PI/2,s=e*Math.cos(n),a=e*Math.sin(n);i===0?t.moveTo(s,a):t.lineTo(s,a)}t.closePath(),t.stroke(),t.restore()}drawNoteVector(t,e,i){const{note:n,cents:s=0}=i,a=this.getNoteIndex(n);if(a===null)return;const r=Math.PI*2*a/12-Math.PI/2,h=e*(.65+Math.min(Math.abs(s)/120,.35)),l=Math.max(Math.min(s/50,1),-1)>=0?this.baseColors[0]:this.baseColors[1];t.save(),t.rotate(r);const d=t.createLinearGradient(0,0,h,0);d.addColorStop(0,"rgba(255,255,255,0.2)"),d.addColorStop(1,l),t.strokeStyle=d,t.lineWidth=4,t.beginPath(),t.moveTo(0,0),t.lineTo(h,0),t.stroke(),t.fillStyle=l,t.beginPath(),t.arc(h,0,6,0,Math.PI*2),t.fill(),t.restore()}drawChord(t,e,i){if(!i.chord)return;const n=this.extractChordNotes(i.chord);n.length!==0&&(t.save(),t.fillStyle="rgba(255, 255, 255, 0.08)",t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=1,t.beginPath(),n.forEach((s,a)=>{const r=this.getNoteIndex(s);if(r===null)return;const h=Math.PI*2*r/12-Math.PI/2,o=e*Math.cos(h),l=e*Math.sin(h);a===0?t.moveTo(o,l):t.lineTo(o,l)}),t.closePath(),t.fill(),t.stroke(),t.restore())}extractChordNotes(t){if(!t)return[];const[e,i]=t.split(" "),n={Major:[0,4,7],Minor:[0,3,7],Diminished:[0,3,6],Augmented:[0,4,8],Sus2:[0,2,7],Sus4:[0,5,7],Major7:[0,4,7,11],Minor7:[0,3,7,10],Dominant7:[0,4,7,10]},s=this.getNoteIndex(e),a=n[i]||[];return s===null?[]:a.map(r=>this.getNoteFromIndex(s+r))}getNoteIndex(t){if(!t)return null;const e=t.replace(/\d+/g,"");return g[e]??null}getNoteFromIndex(t){const e=(t%12+12)%12,i=Object.entries(g);for(const[n,s]of i)if(s===e&&!n.includes("b"))return n;return"C"}}class M{constructor(){this.startButton=document.getElementById("start-note-detection"),this.stopButton=document.getElementById("stop-note-detection"),this.statusMessage=document.getElementById("status-message"),this.noteDisplay=document.getElementById("note-display"),this.frequencyDisplay=document.getElementById("frequency-display"),this.chordDisplay=document.getElementById("chord-display"),this.waveformCanvas=document.getElementById("waveform-canvas"),this.canvasCtx=this.waveformCanvas?this.waveformCanvas.getContext("2d"):null,this.microphoneSelect=document.getElementById("microphone-select"),this.melodyTracker=document.getElementById("melody-tracker"),this.clearMelodyButton=document.getElementById("clear-melody"),this.visualKeyboard=document.getElementById("visual-keyboard"),this.powerLed=document.getElementById("power-led"),this.signalLed=document.getElementById("signal-led"),this.octaveDisplay=document.getElementById("octave-display"),this.scaleDisplay=document.getElementById("scale-display"),this.audioContext=null,this.analyser=null,this.microphone=null,this.isDetecting=!1,this.availableDevices=[],this.lastNote=null,this.noteLingerTimeout=null,this.melodyHistory=[],this.waveformColors=["#ff00ff","#00ffff","#ffff00","#00ff00","#ff6600"],this.colorIndex=0,this.activeKeys=new Set,this.keyLingerTimeouts=new Map,this.detectedNotes=new Map,this.currentChord=null,this.pitchOptions={minFrequency:70,maxFrequency:2e3,maxCentError:70},this.geometryScope=null,this.detectFrameId=null,this.waveformFrameId=null,this.uiFrameId=null,this.pendingUiPayload=null,this.mediaStream=null,this.boundVisibilityHandler=null,this.boundUnloadHandler=null,this.chordPatterns={Major:[0,4,7],Minor:[0,3,7],Diminished:[0,3,6],Augmented:[0,4,8],Sus2:[0,2,7],Sus4:[0,5,7],Major7:[0,4,7,11],Minor7:[0,3,7,10],Dominant7:[0,4,7,10]},this.init(),this.attachLifecycleHooks()}init(){this.loadMicrophones(),this.generateKeyboard(),this.startButton&&this.startButton.addEventListener("click",()=>this.start()),this.stopButton&&this.stopButton.addEventListener("click",()=>this.stop()),this.clearMelodyButton&&this.clearMelodyButton.addEventListener("click",()=>this.clearMelody()),typeof window<"u"&&(this.geometryScope=new S)}attachLifecycleHooks(){typeof document>"u"||this.boundVisibilityHandler||(this.boundVisibilityHandler=()=>this.handleVisibilityChange(),document.addEventListener("visibilitychange",this.boundVisibilityHandler),this.boundUnloadHandler=()=>this.dispose(),window.addEventListener("beforeunload",this.boundUnloadHandler))}detachLifecycleHooks(){this.boundVisibilityHandler&&typeof document<"u"&&(document.removeEventListener("visibilitychange",this.boundVisibilityHandler),this.boundVisibilityHandler=null),this.boundUnloadHandler&&(window.removeEventListener("beforeunload",this.boundUnloadHandler),this.boundUnloadHandler=null)}handleVisibilityChange(){this.audioContext&&(document.hidden&&this.audioContext.state==="running"?this.audioContext.suspend():!document.hidden&&this.audioContext.state==="suspended"&&this.isDetecting&&this.audioContext.resume())}queueUiRender(t){this.pendingUiPayload=t;const e=typeof window<"u"?window.requestAnimationFrame:null;if(!e){this.flushPendingUi();return}this.uiFrameId||(this.uiFrameId=e(()=>this.flushPendingUi()))}flushPendingUi(){const t=this.pendingUiPayload;if(this.pendingUiPayload=null,this.uiFrameId=null,!!t)switch(t.type){case"note":this.renderNotePayload(t);break;case"clear":this.renderClearPayload();break;case"signalOff":this.signalLed&&this.signalLed.classList.remove("on");break}}renderNotePayload(t){const{note:e,frequency:i,cents:n,chord:s,octave:a,scale:r,melodyText:h,highlightNote:o,highlightIntensity:l}=t;if(this.noteDisplay&&(this.noteDisplay.textContent=e),this.frequencyDisplay){const d=n>=0?`+${n.toFixed(1)}Â¢`:`${n.toFixed(1)}Â¢`;this.frequencyDisplay.textContent=`${i.toFixed(2)} Hz (${d})`}this.signalLed&&this.signalLed.classList.add("on"),this.chordDisplay&&(this.chordDisplay.textContent=s||"---"),this.octaveDisplay&&(this.octaveDisplay.textContent=`Octave: ${a}`),this.scaleDisplay&&(this.scaleDisplay.textContent=`Scale: ${r}`),this.melodyTracker&&(this.melodyTracker.textContent=h),o&&this.lightUpKey(o,l),this.geometryScope?.updateFromNote(t)}renderClearPayload(){this.noteDisplay&&(this.noteDisplay.textContent="---"),this.frequencyDisplay&&(this.frequencyDisplay.textContent="0.00 Hz"),this.signalLed&&this.signalLed.classList.remove("on"),this.chordDisplay&&(this.chordDisplay.textContent="---"),this.octaveDisplay&&(this.octaveDisplay.textContent="Octave: -"),this.scaleDisplay&&(this.scaleDisplay.textContent="Scale: -"),this.geometryScope?.clear()}scheduleNoteClear(){this.noteLingerTimeout&&clearTimeout(this.noteLingerTimeout),this.noteLingerTimeout=setTimeout(()=>{this.queueUiRender({type:"clear"})},2e3)}getScaleLabel(){return this.currentChord?this.currentChord.includes("Major")?"Major":this.currentChord.includes("Minor")?"Minor":this.currentChord.split(" ")[1]||"-":"-"}async loadMicrophones(){try{await navigator.mediaDevices.getUserMedia({audio:!0});const t=await navigator.mediaDevices.enumerateDevices();if(this.availableDevices=t.filter(e=>e.kind==="audioinput"),this.microphoneSelect){if(this.microphoneSelect.innerHTML="",this.availableDevices.length===0){this.microphoneSelect.innerHTML='<option value="">No microphones found</option>';return}this.microphoneSelect.innerHTML='<option value="">Default Microphone</option>',this.availableDevices.forEach((e,i)=>{const n=document.createElement("option");n.value=e.deviceId,n.textContent=e.label||`Microphone ${i+1}`,this.microphoneSelect.appendChild(n)})}}catch(t){console.error("Error loading microphones:",t),this.microphoneSelect&&(this.microphoneSelect.innerHTML='<option value="">Error loading microphones</option>')}}generateKeyboard(){if(!this.visualKeyboard)return;this.visualKeyboard.innerHTML="";const t=["C","D","E","F","G","A","B"],e=["C#","D#","F#","G#","A#"];for(let s=3;s<=5;s++)t.forEach(a=>{const r=document.createElement("div");r.className="piano-key white",r.dataset.note=a+s,r.textContent=a+s,this.visualKeyboard.appendChild(r)});const i=this.visualKeyboard.querySelectorAll(".white"),n=[0,1,3,4,5];for(let s=3;s<=5;s++)n.forEach((a,r)=>{const h=(s-3)*7+a,o=i[h];if(o){const l=document.createElement("div");l.className="piano-key black",l.dataset.note=e[r]+s,l.textContent=e[r]+s,this.visualKeyboard.insertBefore(l,o.nextSibling)}})}lightUpKey(t,e=1){const i=this.visualKeyboard.querySelector(`[data-note="${t}"]`);if(i){i.classList.add("active"),i.style.filter=`brightness(${1+e})`,this.activeKeys.add(t),this.keyLingerTimeouts.has(t)&&clearTimeout(this.keyLingerTimeouts.get(t));const n=setTimeout(()=>{i.classList.remove("active"),i.style.filter="",this.activeKeys.delete(t),this.keyLingerTimeouts.delete(t)},1500);this.keyLingerTimeouts.set(t,n)}}detectChord(t){if(t.length<3)return null;const e={C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11},i=t.map(s=>e[s.replace(/\d+/,"")]).sort((s,a)=>s-a),n=i.map(s=>(s-i[0]+12)%12).sort((s,a)=>s-a);for(const[s,a]of Object.entries(this.chordPatterns))if(a.length===n.length&&a.every((r,h)=>r===n[h]))return`${Object.keys(e).find(h=>e[h]===i[0])} ${s}`;return`${t.length}-note chord`}drawWaveform(){if(!this.canvasCtx||!this.analyser||!this.isDetecting)return;const t=typeof window<"u"?window.requestAnimationFrame:null;if(!t)return;this.waveformFrameId=t(()=>this.drawWaveform());const e=this.analyser.fftSize,i=new Uint8Array(e);this.analyser.getByteTimeDomainData(i);const n=this.canvasCtx.createLinearGradient(0,0,0,this.waveformCanvas.height);n.addColorStop(0,"rgba(0, 20, 40, 0.8)"),n.addColorStop(.5,"rgba(0, 10, 20, 0.9)"),n.addColorStop(1,"rgba(0, 20, 40, 0.8)"),this.canvasCtx.fillStyle=n,this.canvasCtx.fillRect(0,0,this.waveformCanvas.width,this.waveformCanvas.height);for(let o=0;o<3;o++){const l=1-o*.3,d=3-o,m=o*2;this.canvasCtx.lineWidth=d,this.canvasCtx.strokeStyle=this.waveformColors[this.colorIndex]+Math.floor(l*255).toString(16).padStart(2,"0"),this.canvasCtx.beginPath();const f=this.waveformCanvas.width*1/e;let u=0;for(let c=0;c<e;c++){const p=i[c]/128*this.waveformCanvas.height/2+m;c===0?this.canvasCtx.moveTo(u,p):this.canvasCtx.lineTo(u,p),u+=f}this.canvasCtx.stroke()}this.canvasCtx.shadowColor=this.waveformColors[this.colorIndex],this.canvasCtx.shadowBlur=10,this.canvasCtx.lineWidth=1,this.canvasCtx.strokeStyle=this.waveformColors[this.colorIndex],this.canvasCtx.beginPath();const s=this.waveformCanvas.width*1/e;let a=0;for(let o=0;o<e;o++){const d=i[o]/128*this.waveformCanvas.height/2;o===0?this.canvasCtx.moveTo(a,d):this.canvasCtx.lineTo(a,d),a+=s}this.canvasCtx.stroke(),this.canvasCtx.shadowBlur=0;const r=Date.now()*.005,h=(Math.sin(r)+1)*.5;this.canvasCtx.strokeStyle=`rgba(0, 255, 255, ${.3+h*.3})`,this.canvasCtx.lineWidth=1,this.canvasCtx.beginPath(),this.canvasCtx.moveTo(0,this.waveformCanvas.height/2),this.canvasCtx.lineTo(this.waveformCanvas.width,this.waveformCanvas.height/2),this.canvasCtx.stroke()}detectNoteLoop(){if(!this.analyser||!this.isDetecting)return;const t=typeof window<"u"?window.requestAnimationFrame:null,e=this.analyser.fftSize,i=new Float32Array(e);this.analyser.getFloatTimeDomainData(i);let n=0,s=-1;const a=this.audioContext.sampleRate;for(let o=40;o<e;o++){let l=0;for(let d=0;d<e-o;d++)l+=i[d]*i[d+o];l>n&&(n=l,s=o)}const r=s>0?a/s:0,h=b(r,this.pitchOptions);if(h){const o=h.note;o!==this.lastNote&&(this.melodyHistory.push(o),this.lastNote=o,this.colorIndex=(this.colorIndex+1)%this.waveformColors.length),this.detectedNotes.set(o,Date.now());const l=Date.now();for(const[u,c]of this.detectedNotes.entries())l-c>1e3&&this.detectedNotes.delete(u);const d=Array.from(this.detectedNotes.keys());this.currentChord=this.detectChord(d);const m=o.match(/\d+/)?.[0]??"-",f=this.melodyHistory.slice(-12).join(" - ");this.queueUiRender({type:"note",note:o,frequency:r,cents:h.cents,chord:this.currentChord,octave:m,scale:this.getScaleLabel(),melodyText:f,highlightNote:o,highlightIntensity:1+Math.min(Math.abs(h.cents)/50,1)}),this.scheduleNoteClear()}else this.queueUiRender({type:"signalOff"});this.isDetecting&&t&&(this.detectFrameId=t(()=>this.detectNoteLoop()))}async start(){if(!this.isDetecting)try{const t=this.microphoneSelect?this.microphoneSelect.value:null,e={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}};t&&(e.audio.deviceId={exact:t}),this.mediaStream=await navigator.mediaDevices.getUserMedia(e),this.audioContext=I(),this.microphone=this.audioContext.createMediaStreamSource(this.mediaStream),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.microphone.connect(this.analyser),this.isDetecting=!0,this.startButton&&(this.startButton.disabled=!0),this.stopButton&&(this.stopButton.disabled=!1),this.powerLed&&this.powerLed.classList.add("on"),this.statusMessage&&(this.statusMessage.textContent="ðŸŸ¢ Live Note Detection Active"),this.detectNoteLoop(),this.drawWaveform()}catch(t){this.statusMessage&&(this.statusMessage.textContent="âŒ Error: "+t.message),this.stop()}}stop(){if(!this.isDetecting){this.resetUiState();return}this.isDetecting=!1,D(this.mediaStream),this.mediaStream=null,y(this.detectFrameId),y(this.waveformFrameId),y(this.uiFrameId),this.detectFrameId=null,this.waveformFrameId=null,this.uiFrameId=null,x(this.audioContext),this.audioContext=null,this.analyser=null,this.microphone=null,this.startButton&&(this.startButton.disabled=!1),this.stopButton&&(this.stopButton.disabled=!0),this.powerLed&&this.powerLed.classList.remove("on"),this.statusMessage&&(this.statusMessage.textContent="ðŸ”´ Note Detection Inactive"),this.resetUiState()}resetUiState(){this.queueUiRender({type:"clear"}),this.canvasCtx&&this.waveformCanvas&&this.canvasCtx.clearRect(0,0,this.waveformCanvas.width,this.waveformCanvas.height)}dispose(){this.stop(),this.detachLifecycleHooks(),this.geometryScope?.dispose(),this.startButton&&this.startButton.replaceWith(this.startButton.cloneNode(!0)),this.stopButton&&this.stopButton.replaceWith(this.stopButton.cloneNode(!0))}clearMelody(){this.melodyHistory=[],this.melodyTracker&&(this.melodyTracker.textContent="")}}document.addEventListener("DOMContentLoaded",()=>{new C().init(),new w,new M});
