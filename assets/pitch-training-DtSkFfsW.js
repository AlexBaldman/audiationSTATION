import{A as u,N as m}from"./Navigation-BNncwhjL.js";import{f as y}from"./PitchUtils-Dm8PaPCI.js";import{c as f,s as p,a as g,b as T}from"./AudioResourceManager-DnsOnIC-.js";class b{constructor(){this.startButton=document.getElementById("start-pitch-training"),this.stopButton=document.getElementById("stop-pitch-training"),this.targetNoteDisplay=document.getElementById("target-note"),this.userNoteDisplay=document.getElementById("user-note"),this.pitchMeter=document.getElementById("pitch-meter"),this.pitchIndicator=document.getElementById("pitch-indicator"),this.feedbackMessage=document.getElementById("pitch-feedback"),this.scoreDisplay=document.getElementById("pitch-score"),this.streakDisplay=document.getElementById("pitch-streak"),this.timerDisplay=document.getElementById("pitch-timer"),this.accuracyDisplay=document.getElementById("pitch-accuracy"),this.bestStreakDisplay=document.getElementById("pitch-best-streak"),this.notesTrainedDisplay=document.getElementById("pitch-notes-trained"),this.volumeFill=document.getElementById("pitch-volume-fill"),this.guidanceDisplay=document.getElementById("pitch-guidance"),this.difficultySelect=document.getElementById("pitch-difficulty"),this.instrumentSelect=document.getElementById("instrument-select"),this.playTargetNoteButton=document.getElementById("play-target-note"),this.audioContext=null,this.analyser=null,this.microphone=null,this.mediaStream=null,this.isTraining=!1,this.targetNote=null,this.targetFrequency=0,this.score=0,this.streak=0,this.bestStreak=0,this.totalNotesTrained=0,this.matchesHit=0,this.gameTimer=null,this.timeLeft=60,this.noteMatchedTime=0,this.instrumentType="sine",this.detectFrameId=null,this.nextNoteTimeout=null,this.boundVisibilityHandler=null,this.boundUnloadHandler=null,this.noteFrequencies={C4:261.63,D4:293.66,E4:329.63,F4:349.23,G4:392,A4:440,B4:493.88,C5:523.25},this.difficultyRanges={easy:["C4","E4","G4","C5"],medium:["C4","D4","E4","F4","G4","A4","B4","C5"],hard:Object.keys(this.noteFrequencies)},this.init(),this.attachLifecycleHooks()}init(){this.startButton&&this.startButton.addEventListener("click",()=>this.start()),this.stopButton&&this.stopButton.addEventListener("click",()=>this.stop()),this.playTargetNoteButton&&this.playTargetNoteButton.addEventListener("click",()=>this.playTargetNote()),this.instrumentSelect&&(this.instrumentType=this.instrumentSelect.value,this.instrumentSelect.addEventListener("change",()=>{this.instrumentType=this.instrumentSelect.value}))}playInstrumentTone(e){if(!this.audioContext)return;const t=this.audioContext.createOscillator(),i=this.audioContext.createGain();t.connect(i),i.connect(this.audioContext.destination),t.type=this.instrumentType,t.frequency.setValueAtTime(e,this.audioContext.currentTime),i.gain.setValueAtTime(.3,this.audioContext.currentTime),i.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+1),t.start(),t.stop(this.audioContext.currentTime+1)}generateTargetNote(){const e=this.difficultySelect?this.difficultySelect.value:"easy",t=this.difficultyRanges[e],i=Math.floor(Math.random()*t.length);this.targetNote=t[i],this.targetFrequency=this.noteFrequencies[this.targetNote],this.targetNoteDisplay&&(this.targetNoteDisplay.textContent=`Target: ${this.targetNote}`),this.noteMatchedTime=0,this.totalNotesTrained++,this.notesTrainedDisplay&&(this.notesTrainedDisplay.textContent=this.totalNotesTrained),this.playTargetNote()}playTargetNote(){this.targetFrequency&&this.playInstrumentTone(this.targetFrequency)}updatePitchMeter(e){if(!this.targetFrequency||!this.pitchIndicator)return;const t=1200*Math.log2(e/this.targetFrequency),i=Math.max(-50,Math.min(50,t));if(this.pitchIndicator.style.left=`calc(50% + ${i}%)`,Math.abs(t)<10?this.pitchIndicator.style.backgroundColor="#00ff00":Math.abs(t)<30?this.pitchIndicator.style.backgroundColor="#ffff00":this.pitchIndicator.style.backgroundColor="#ff0000",this.guidanceDisplay){const r=t>3?"Lower pitch slightly":t<-3?"Raise pitch slightly":"Right on pitch";this.guidanceDisplay.textContent=`${r} (Î” ${t.toFixed(1)}Â¢)`}}detectPitchLoop(){if(!this.isTraining||!this.analyser)return;const e=this.analyser.fftSize,t=new Float32Array(e);this.analyser.getFloatTimeDomainData(t);const i=Math.sqrt(t.reduce((n,s)=>n+s*s,0)/e);this.volumeFill&&(this.volumeFill.style.width=`${Math.min(100,Math.max(5,i*350))}%`);let r=0,h=-1;const d=this.audioContext.sampleRate;for(let n=40;n<e;n++){let s=0;for(let a=0;a<e-n;a++)s+=t[a]*t[a+n];s>r&&(r=s,h=n)}const o=h>0?d/h:0;if(o>100){const s=y(o,{minFrequency:80,maxFrequency:1500,maxCentError:80})?.note||"---";if(this.userNoteDisplay&&(this.userNoteDisplay.textContent=`You: ${s} (${o.toFixed(2)} Hz)`),this.updatePitchMeter(o),s===this.targetNote&&Math.abs(1200*Math.log2(o/this.targetFrequency))<15){if(this.noteMatchedTime===0&&(this.noteMatchedTime=Date.now()),Date.now()-this.noteMatchedTime>500){if(this.feedbackMessage&&(this.feedbackMessage.textContent="âœ… Perfect Match!"),this.score+=10,this.streak++,this.matchesHit++,this.bestStreak=Math.max(this.bestStreak,this.streak),this.scoreDisplay&&(this.scoreDisplay.textContent=this.score),this.streakDisplay&&(this.streakDisplay.textContent=this.streak),this.bestStreakDisplay&&(this.bestStreakDisplay.textContent=this.bestStreak),this.accuracyDisplay){const a=this.totalNotesTrained>0?Math.round(this.matchesHit/this.totalNotesTrained*100):0;this.accuracyDisplay.textContent=`${a}%`}this.nextNoteTimeout&&clearTimeout(this.nextNoteTimeout),this.nextNoteTimeout=setTimeout(()=>this.generateTargetNote(),1e3)}}else this.noteMatchedTime=0,this.streak=0,this.streakDisplay&&(this.streakDisplay.textContent=this.streak),this.feedbackMessage&&(this.feedbackMessage.textContent="ðŸŽ¤ Keep trying!")}else this.userNoteDisplay&&(this.userNoteDisplay.textContent="You: ---"),this.guidanceDisplay&&(this.guidanceDisplay.textContent="Increase input volume or sing a clear note");const l=typeof window<"u"?window.requestAnimationFrame:null;this.isTraining&&l&&(this.detectFrameId=l(()=>this.detectPitchLoop()))}async start(){if(!this.isTraining)try{this.audioContext=f(),this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.microphone=this.audioContext.createMediaStreamSource(this.mediaStream),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.microphone.connect(this.analyser),this.isTraining=!0,this.score=0,this.streak=0,this.timeLeft=60,this.startButton&&(this.startButton.disabled=!0),this.stopButton&&(this.stopButton.disabled=!1),this.scoreDisplay&&(this.scoreDisplay.textContent=this.score),this.streakDisplay&&(this.streakDisplay.textContent=this.streak),this.generateTargetNote(),this.gameTimer=setInterval(()=>{this.timeLeft--,this.timerDisplay&&(this.timerDisplay.textContent=`Time: ${this.timeLeft}s`),this.timeLeft<=0&&this.stop()},1e3),this.detectPitchLoop()}catch(e){this.feedbackMessage&&(this.feedbackMessage.textContent="âŒ Error: "+e.message),this.stop()}}stop(){this.nextNoteTimeout&&(clearTimeout(this.nextNoteTimeout),this.nextNoteTimeout=null),this.isTraining=!1,clearInterval(this.gameTimer),this.gameTimer=null,p(this.mediaStream),this.mediaStream=null,g(this.detectFrameId),this.detectFrameId=null,T(this.audioContext),this.audioContext=null,this.analyser=null,this.microphone=null,this.startButton&&(this.startButton.disabled=!1),this.stopButton&&(this.stopButton.disabled=!0),this.feedbackMessage&&(this.feedbackMessage.textContent=`Game Over! Final Score: ${this.score}`),this.targetNoteDisplay&&(this.targetNoteDisplay.textContent="Target: ---"),this.userNoteDisplay&&(this.userNoteDisplay.textContent="You: ---")}attachLifecycleHooks(){typeof document>"u"||this.boundVisibilityHandler||(this.boundVisibilityHandler=()=>{this.audioContext&&(document.hidden?this.audioContext.suspend?.():this.isTraining&&this.audioContext.resume?.())},document.addEventListener("visibilitychange",this.boundVisibilityHandler),this.boundUnloadHandler=()=>this.dispose(),window.addEventListener("beforeunload",this.boundUnloadHandler))}detachLifecycleHooks(){this.boundVisibilityHandler&&typeof document<"u"&&(document.removeEventListener("visibilitychange",this.boundVisibilityHandler),this.boundVisibilityHandler=null),this.boundUnloadHandler&&(window.removeEventListener("beforeunload",this.boundUnloadHandler),this.boundUnloadHandler=null)}dispose(){this.stop(),this.detachLifecycleHooks()}}document.addEventListener("DOMContentLoaded",()=>{new u().init(),new m,new b});
