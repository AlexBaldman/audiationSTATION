import{A as d,N as h}from"./Navigation-BNncwhjL.js";import{c,b as u}from"./AudioResourceManager-DnsOnIC-.js";class l{constructor(){this.audioContext=null,this.sounds={},this.pads=document.querySelectorAll(".beatbox-pad"),this.padQueue=[],this.padAnimationTimeouts=new Map,this.boundKeyHandler=t=>this.handleKeyTrigger(t),this.keyMap={KeyA:"kick",KeyS:"snare",KeyD:"hihat",KeyF:"cymbal"},this.startBtn=document.getElementById("beatbox-start"),this.stopBtn=document.getElementById("beatbox-stop"),this.tempoSlider=document.getElementById("beatbox-tempo"),this.tempoValue=document.getElementById("beatbox-tempo-value"),this.patternSelect=document.getElementById("beatbox-pattern"),this.gridContainer=document.getElementById("beatbox-grid-steps"),this.gridInfo=document.getElementById("beatbox-grid-info"),this.randomizeBtn=document.getElementById("beatbox-randomize"),this.currentStep=0,this.isPlaying=!1,this.stepInterval=null,this.stepsPerBar=16,this.rows=["kick","snare","hihat","cymbal"],this.gridState=new Map,this.patterns=this.getPatternDefinitions(),this.storageKey="audiation-beatbox-state",this.activePattern="default",this.isRestoring=!1,this.init()}persistState(){if(typeof window>"u"||!window.localStorage)return;const t={pattern:this.activePattern,stepsPerBar:this.stepsPerBar,rows:this.rows.map(e=>({name:e,steps:Array.from({length:this.stepsPerBar},(i,s)=>this.gridState.get(`${e}-${s}`)?s:null).filter(i=>i!==null)}))};try{window.localStorage.setItem(this.storageKey,JSON.stringify(t))}catch(e){console.warn("Unable to persist beatbox state",e)}}loadState(){if(!(typeof window>"u"||!window.localStorage))try{const t=window.localStorage.getItem(this.storageKey);if(!t)return;const e=JSON.parse(t);if(!e?.rows)return;this.isRestoring=!0,this.applyPattern(e.pattern||"default"),this.gridState.clear(),this.gridContainer?.querySelectorAll(".grid-step").forEach(i=>i.classList.remove("active")),e.rows.forEach(i=>{i.steps?.forEach(s=>this.toggleGridStep(i.name,s,!0))})}catch(t){console.warn("Failed to load beatbox state",t)}finally{this.isRestoring=!1}}init(){this.setupAudioContext(),this.setupPads(),this.loadSounds(),this.attachKeyboardShortcuts(),this.buildGrid(),this.attachTransport(),this.applyPattern("default"),this.loadState()}setupAudioContext(){this.audioContext=c()}setupPads(){this.pads.forEach((t,e)=>{const i=this.getSoundType(e);t.addEventListener("click",()=>this.playSound(i)),t.addEventListener("touchstart",s=>{s.preventDefault(),this.playSound(i)}),t.dataset.sound=i})}getSoundType(t){return["kick","snare","hihat","cymbal"][t]||"kick"}loadSounds(){this.sounds={kick:this.createKickSound(),snare:this.createSnareSound(),hihat:this.createHiHatSound(),cymbal:this.createCymbalSound()}}randomizeGrid(){this.isRestoring=!0,this.gridState.clear(),this.gridContainer?.querySelectorAll(".grid-step").forEach(e=>e.classList.remove("active"));const t={kick:.35,snare:.25,hihat:.5,cymbal:.2};this.rows.forEach(e=>{const i=t[e]??.3;for(let s=0;s<this.stepsPerBar;s++)Math.random()<i&&this.toggleGridStep(e,s,!0)}),this.isRestoring=!1,this.persistState(),this.gridInfo&&(this.gridInfo.textContent="Randomized Sacred Grid â€” tweak live with pads or keyboard.")}createKickSound(){return()=>{const t=this.audioContext.createOscillator(),e=this.audioContext.createGain();t.frequency.setValueAtTime(60,this.audioContext.currentTime),t.frequency.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.5),e.gain.setValueAtTime(1,this.audioContext.currentTime),e.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.5),t.connect(e),e.connect(this.audioContext.destination),t.start(),t.stop(this.audioContext.currentTime+.5)}}createSnareSound(){return()=>{const t=this.audioContext.sampleRate*.2,e=this.audioContext.createBuffer(1,t,this.audioContext.sampleRate),i=e.getChannelData(0);for(let a=0;a<t;a++)i[a]=(Math.random()*2-1)*Math.pow(1-a/t,2);const s=this.audioContext.createBufferSource(),n=this.audioContext.createGain();s.buffer=e,n.gain.setValueAtTime(.3,this.audioContext.currentTime),n.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.2),s.connect(n),n.connect(this.audioContext.destination),s.start()}}createHiHatSound(){return()=>{const t=this.audioContext.sampleRate*.1,e=this.audioContext.createBuffer(1,t,this.audioContext.sampleRate),i=e.getChannelData(0);for(let o=0;o<t;o++)i[o]=(Math.random()*2-1)*Math.pow(1-o/t,3);const s=this.audioContext.createBufferSource(),n=this.audioContext.createGain(),a=this.audioContext.createBiquadFilter();a.type="highpass",a.frequency.value=8e3,s.buffer=e,n.gain.setValueAtTime(.2,this.audioContext.currentTime),n.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.1),s.connect(a),a.connect(n),n.connect(this.audioContext.destination),s.start()}}createCymbalSound(){return()=>{const t=this.audioContext.sampleRate*.5,e=this.audioContext.createBuffer(1,t,this.audioContext.sampleRate),i=e.getChannelData(0);for(let o=0;o<t;o++)i[o]=(Math.random()*2-1)*Math.pow(1-o/t,1.5);const s=this.audioContext.createBufferSource(),n=this.audioContext.createGain(),a=this.audioContext.createBiquadFilter();a.type="bandpass",a.frequency.value=3e3,a.Q.value=1,s.buffer=e,n.gain.setValueAtTime(.1,this.audioContext.currentTime),n.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.5),s.connect(a),a.connect(n),n.connect(this.audioContext.destination),s.start()}}playSound(t){this.sounds[t]&&(this.sounds[t](),this.enqueuePadAnimation(t))}enqueuePadAnimation(t){const e=Array.from(this.pads).find(s=>s.dataset.sound===t);if(!e)return;this.padAnimationTimeouts.has(e)&&clearTimeout(this.padAnimationTimeouts.get(e)),e.style.transform="scale(0.95)",e.style.filter="brightness(1.5)";const i=setTimeout(()=>{e.style.transform="scale(1)",e.style.filter="brightness(1)",this.padAnimationTimeouts.delete(e)},120);this.padAnimationTimeouts.set(e,i)}attachKeyboardShortcuts(){window.addEventListener("keydown",this.boundKeyHandler)}handleKeyTrigger(t){const e=this.keyMap[t.code];e&&(t.preventDefault(),this.playSound(e),this.toggleGridStep(e,this.currentStep,!0))}buildGrid(){this.gridContainer&&(this.gridContainer.innerHTML="",this.rows.forEach(t=>{const e=document.createElement("div");e.className="grid-row";const i=document.createElement("div");i.className="grid-row-label",i.textContent=t;const s=document.createElement("div");s.className="grid-row-steps";for(let n=0;n<this.stepsPerBar;n++){const a=document.createElement("button");a.type="button",a.className="grid-step",a.dataset.row=t,a.dataset.step=n,a.addEventListener("click",()=>this.toggleGridStep(t,n)),s.appendChild(a)}e.appendChild(i),e.appendChild(s),this.gridContainer.appendChild(e)}))}toggleGridStep(t,e,i=null){const s=`${t}-${e}`,n=this.gridContainer?.querySelector(`.grid-step[data-row="${t}"][data-step="${e}"]`);if(!n)return;const a=i!==null?i:!this.gridState.get(s);this.gridState.set(s,a),n.classList.toggle("active",a),this.isRestoring||this.persistState()}attachTransport(){this.startBtn?.addEventListener("click",()=>this.startSequencer()),this.stopBtn?.addEventListener("click",()=>this.stopSequencer()),this.tempoSlider?.addEventListener("input",t=>{const e=Number(t.target.value);this.tempoValue&&(this.tempoValue.textContent=`${e} BPM`),this.isPlaying&&(this.stopSequencer(),this.startSequencer())}),this.patternSelect?.addEventListener("change",t=>{this.applyPattern(t.target.value)}),this.randomizeBtn?.addEventListener("click",()=>this.randomizeGrid())}startSequencer(){if(this.isPlaying)return;this.audioContext||this.setupAudioContext(),this.audioContext.resume(),this.isPlaying=!0,this.currentStep=0;const e=6e4/Number(this.tempoSlider?.value||108)/4;this.stepInterval=setInterval(()=>this.advanceStep(),e),this.startBtn&&(this.startBtn.disabled=!0),this.stopBtn&&(this.stopBtn.disabled=!1)}stopSequencer(){this.isPlaying&&(this.isPlaying=!1,clearInterval(this.stepInterval),this.stepInterval=null,this.clearPlayhead(),this.startBtn&&(this.startBtn.disabled=!1),this.stopBtn&&(this.stopBtn.disabled=!0))}advanceStep(){this.clearPlayhead(),this.rows.forEach(t=>{const e=`${t}-${this.currentStep}`;this.gridState.get(e)&&this.playSound(t),this.gridContainer?.querySelector(`.grid-step[data-row="${t}"][data-step="${this.currentStep}"]`)?.classList.add("playhead")}),this.currentStep=(this.currentStep+1)%this.stepsPerBar}clearPlayhead(){this.gridContainer?.querySelectorAll(".grid-step.playhead").forEach(t=>t.classList.remove("playhead"))}applyPattern(t){const e=this.patterns[t]||this.patterns.default;this.activePattern=t in this.patterns?t:"default",this.gridState.clear(),this.gridContainer?.querySelectorAll(".grid-step").forEach(i=>i.classList.remove("active")),this.rows.forEach((i,s)=>{(e.steps[s]||[]).forEach(a=>this.toggleGridStep(i,a,!0))}),this.gridInfo&&(this.gridInfo.textContent=e.description),this.isRestoring||this.persistState()}getPatternDefinitions(){return{default:{steps:[[0,4,8,12],[4,12],[2,6,10,14],[0,8]],description:"Balanced 4/4 grid with kick on quarters and hats on the off-beats."},fibonacci:{steps:[[0,1,3,5,8,13],[5,8,13],[2,3,5,8,13],[1,4,7,11,14]],description:"Fibonacci spacing to create expanding syncopation (1-1-2-3-5-8)."},trinity:{steps:[[0,8],[4,12],[2,6,10,14],[3,9,15]],description:"3:2 polyrhythm where hi-hats trace triplets over duple kicks."},golden:{steps:[[0,7,11],[3,9,14],[2,5,8,13],[1,4,6,10,12,15]],description:"Golden ratio accents: 0/0.618/1 overlays for evolving shimmer."}}}dispose(){this.padAnimationTimeouts.forEach(t=>clearTimeout(t)),this.padAnimationTimeouts.clear(),window.removeEventListener("keydown",this.boundKeyHandler),this.stopSequencer(),u(this.audioContext),this.audioContext=null}}document.addEventListener("DOMContentLoaded",()=>{new d().init(),new h,new l});
