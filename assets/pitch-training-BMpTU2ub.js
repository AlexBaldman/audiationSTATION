import{A as S,N as b}from"./Navigation-BNncwhjL.js";import{f as w}from"./PitchUtils-Dm8PaPCI.js";import{c as v,s as T,a as C,b as E}from"./AudioResourceManager-DnsOnIC-.js";const g={smoothingFactor:.15,gateSmoothing:.25,maxCentWindow:50,tempoBPM:96,palette:{background:"#030112",primary:"#5cf2ff",accent:"#f6c177",danger:"#ff4d6d"},seed:123456789},p=typeof window<"u"&&typeof window.requestAnimationFrame=="function"?window.requestAnimationFrame.bind(window):a=>setTimeout(()=>a(Date.now()),16),M=typeof window<"u"&&typeof window.cancelAnimationFrame=="function"?window.cancelAnimationFrame.bind(window):a=>clearTimeout(a);function k(){return{cents:0,onTarget:!1,rms:0,timestamp:typeof performance<"u"&&performance.now?performance.now():Date.now()}}function D(){return{time:0,delta:16,normalizedError:0,gateHeight:.5,confidence:0,streakLevel:0,onTarget:!1,bpmPhase:0,notesHit:0}}function x(){const a=new Map;return{on(t,e){a.has(t)||a.set(t,new Set),a.get(t).add(e)},off(t,e){const i=a.get(t);i&&(i.delete(e),i.size===0&&a.delete(t))},emit(t,e){const i=a.get(t);if(i)for(const s of i)s(e)},clear(){a.clear()}}}function I(a=Date.now()){let t=a>>>0;return()=>{t+=1831565813;let e=t;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}}function d(a,t,e){return Number.isNaN(a)?t:Math.min(Math.max(a,t),e)}function m(a,t,e=.15){const i=d(1-e,0,1);return a*i+t*(1-i)}function F(a,t=50){return!Number.isFinite(a)||!Number.isFinite(t)||t<=0?0:d(a/t,-1,1)}function B(a){const t=.5-a*.5;return d(t,0,1)}function N(a){const t=d(a,0,1);return t*t*(3-2*t)}class G{constructor(t,e={}){if(!t)throw new Error("GamifiedPitchEngine requires a canvas element.");this.canvas=t,this.ctx=t.getContext?.("2d")??null,this.config={...g,...e,palette:{...g.palette,...e.palette||{}}},this.eventBus=x(),this.sceneRegistry=new Map,this.sceneStores=new Map,this.assetCache=new Map,this.sceneContext=this.buildSceneContext(),this.lastPitchSample=k(),this.frameState=D(),this.lastFrameTime=0,this.rafId=null,this.isRunning=!1,this.activeScene=null,this.activeSceneId=null}buildSceneContext(){const t=I(this.config.seed);return{canvas:this.canvas,ctx:this.ctx,palette:this.config.palette,rng:t,ease:{smoothstep:N},store:this.sceneStores,getAsset:(e,i)=>this.getAsset(e,i),emit:(e,i)=>this.emitSceneEvent(e,i)}}registerScene(t){if(!t||!t.id||typeof t.create!="function")throw new Error("Scene definitions require `id` and `create(context)` factory.");this.sceneRegistry.set(t.id,t)}hasScene(t){return this.sceneRegistry.has(t)}loadScene(t){if(!t)return;if(!this.sceneRegistry.has(t))throw new Error(`Scene "${t}" is not registered.`);this.disposeActiveScene();const i=this.sceneRegistry.get(t).create(this.sceneContext);i?.init?.(this.sceneContext),this.activeScene=i,this.activeSceneId=t,this.emitSceneEvent("scene-change",{sceneId:t})}setMode(t){if(t==="off"){this.disable();return}this.loadScene(t)}disable(){this.disposeActiveScene(),this.activeScene=null,this.activeSceneId=null,this.emitSceneEvent("scene-disabled")}disposeActiveScene(){this.activeScene?.dispose&&this.activeScene.dispose()}start(){this.isRunning||!this.ctx||(this.isRunning=!0,this.lastFrameTime=typeof performance<"u"&&performance.now?performance.now():Date.now(),this.rafId=p(t=>this.loop(t)))}pause(){this.isRunning&&(this.isRunning=!1,this.rafId!==null&&(M(this.rafId),this.rafId=null))}resume(){this.isRunning||!this.ctx||(this.isRunning=!0,this.lastFrameTime=typeof performance<"u"&&performance.now?performance.now():Date.now(),this.rafId=p(t=>this.loop(t)))}stop(){this.pause(),this.disable()}dispose(){this.stop(),this.eventBus?.clear?.(),this.assetCache.clear()}loop(t){if(!this.isRunning)return;const e=typeof t=="number"?t:typeof performance<"u"&&performance.now?performance.now():Date.now(),i=this.lastFrameTime?e-this.lastFrameTime:16;this.lastFrameTime=e;const s=this.buildFrameState(e,i);this.activeScene?.update&&this.activeScene.update(s,this.sceneContext),this.activeScene?.render&&this.ctx&&(this.ctx.save?.(),this.ctx.clearRect?.(0,0,this.canvas.width,this.canvas.height),this.activeScene.render(this.ctx,s,this.sceneContext),this.ctx.restore?.()),this.rafId=p(n=>this.loop(n))}buildFrameState(t,e){const i=m(this.frameState.normalizedError,F(this.lastPitchSample.cents,this.config.maxCentWindow),this.config.smoothingFactor),s=m(this.frameState.gateHeight,B(i),this.config.gateSmoothing),n=m(this.frameState.confidence,d(this.lastPitchSample.rms*4,0,1),this.config.smoothingFactor),h=this.lastPitchSample.onTarget?this.frameState.streakLevel+1:0,o=(this.frameState.bpmPhase+this.config.tempoBPM/6e4*e)%1,u=this.lastPitchSample.onTarget?this.frameState.notesHit:this.frameState.notesHit;return this.frameState={time:t,delta:e,normalizedError:i,gateHeight:s,confidence:n,streakLevel:h,onTarget:this.lastPitchSample.onTarget,bpmPhase:o,notesHit:u},this.frameState}updatePitch(t={}){this.lastPitchSample={...this.lastPitchSample,...t,timestamp:t.timestamp||(typeof performance<"u"&&performance.now?performance.now():Date.now())},t.onTarget&&this.frameState&&(this.frameState.notesHit+=1)}emitSceneEvent(t,e={}){this.eventBus.emit("scene-event",{name:t,detail:e,sceneId:this.activeSceneId,timestamp:typeof performance<"u"&&performance.now?performance.now():Date.now()})}addEventListener(t,e){return this.eventBus.on(t,e),()=>this.removeEventListener(t,e)}removeEventListener(t,e){this.eventBus.off(t,e)}getAsset(t,e){if(this.assetCache.has(t))return this.assetCache.get(t);if(typeof e!="function")throw new Error(`Loader for asset "${t}" must be a function.`);const i=Promise.resolve().then(e).then(s=>(this.assetCache.set(t,Promise.resolve(s)),s));return this.assetCache.set(t,i),i}}function P(a,t,e,i){const s=e/2+i;return Math.abs(a-t)<=s}class A{constructor(){this.id="gatekeeper",this.name="Gatekeeper",this.description="Guide the orb through energy gates by matching pitch height.",this.orbY=.5,this.passX=.32,this.passTolerance=.08,this.baseOpening=.32,this.minOpening=.18,this.tunnelSpeed=45e-5,this.spawnInterval=1500,this.elapsedSinceSpawn=0,this.gates=[],this.store=null,this.context=null,this.gateCounter=0,this.orbFollowRate=.18}init(t){this.context=t,this.store=t.store.get?.(this.id)??new Map,t.store.set?.(this.id,this.store),this.reset()}reset(){this.orbY=.5,this.elapsedSinceSpawn=0,this.gates=[]}update(t,e){const i=t?.delta||16;this.elapsedSinceSpawn+=i,this.elapsedSinceSpawn>=this.spawnInterval&&(this.spawnGate(t),this.elapsedSinceSpawn=0);const s=d(this.orbFollowRate+(t.confidence||0)*.2,.08,.4),n=d(t.gateHeight??.5,.05,.95);this.orbY+=(n-this.orbY)*s;const h=this.tunnelSpeed*i;for(const o of this.gates)o.x-=h,!o.resolved&&o.x<=this.passX&&this.resolveGate(o,t,e);this.gates=this.gates.filter(o=>o.x>-.2)}spawnGate(t={}){const e=((this.context?.rng?.()??Math.random())-.5)*.2,i=d((t.gateHeight??.5)+e,.15,.85),s=d((t.streakLevel||0)*.01,0,.12),n=d(this.baseOpening-s,this.minOpening,this.baseOpening);this.gates.push({id:`gate-${this.gateCounter++}`,x:1.1,center:i,opening:n,resolved:!1,status:"pending"})}resolveGate(t,e,i){const s=P(this.orbY,t.center,t.opening,this.passTolerance);t.resolved=!0,t.status=s?"passed":"missed";const n={gateId:t.id,center:t.center,opening:t.opening,streakLevel:e.streakLevel};s?i.emit?.("gatePassed",n):i.emit?.("gateMissed",n)}render(t,e,i){if(!t||!i?.canvas)return;const{width:s,height:n}=i.canvas;t.clearRect(0,0,s,n),this.drawBackground(t,s,n,i.palette),this.drawTunnelLines(t,s,n),this.drawGates(t,s,n,i.palette,e),this.drawOrb(t,s,n,i.palette,e)}drawBackground(t,e,i,s={}){const n=t.createLinearGradient(0,0,0,i);n.addColorStop(0,s.background??"#05030f"),n.addColorStop(1,"#09051c"),t.fillStyle=n,t.fillRect(0,0,e,i)}drawTunnelLines(t,e,i){t.strokeStyle="rgba(255,255,255,0.05)",t.lineWidth=1;for(let s=0;s<=6;s++){const n=s/6*e;t.beginPath(),t.moveTo(n,0),t.lineTo(n+e*.05,i),t.stroke()}}drawGates(t,e,i,s={}){const n=e*.06;for(const h of this.gates){const o=h.x*e;if(o+n<0||o>e)continue;const u=h.center*i,c=h.opening*i,l=u-c/2,r=u+c/2;t.fillStyle=h.status==="missed"?s.danger??"#ff4d6d":s.primary??"#5cf2ff",t.globalAlpha=h.status==="pending"?.6:.35,t.fillRect(o,0,n,Math.max(0,l)),t.fillRect(o,r,n,Math.max(0,i-r)),t.globalAlpha=1,t.strokeStyle="rgba(255,255,255,0.15)",t.strokeRect(o,0,n,i)}}drawOrb(t,e,i,s={},n={}){const h=this.passX*e+e*.05,o=d(this.orbY,.05,.95)*i,u=16,c=d((n.streakLevel||0)*.5,0,6),l=u-c,r=n.onTarget?s.primary??"#5cf2ff":s.accent??"#f6c177";t.shadowColor=r,t.shadowBlur=n.onTarget?25:10,t.fillStyle=r,t.beginPath(),t.arc(h,o,l,0,Math.PI*2),t.fill(),t.shadowBlur=0,t.lineWidth=2,t.strokeStyle="rgba(255,255,255,0.3)",t.stroke()}dispose(){this.gates=[]}}function L(){return{id:"gatekeeper",name:"Gatekeeper",description:"Guide the orb through gates by matching pitch height.",difficulty:"medium",create:()=>new A}}function H(a,t={}){const e=new G(a,t),i=[L()];for(const s of i)e.registerScene(s);return e}class R{constructor(){this.startButton=document.getElementById("start-pitch-training"),this.stopButton=document.getElementById("stop-pitch-training"),this.targetNoteDisplay=document.getElementById("target-note"),this.userNoteDisplay=document.getElementById("user-note"),this.pitchMeter=document.getElementById("pitch-meter"),this.pitchIndicator=document.getElementById("pitch-indicator"),this.feedbackMessage=document.getElementById("pitch-feedback"),this.scoreDisplay=document.getElementById("pitch-score"),this.streakDisplay=document.getElementById("pitch-streak"),this.timerDisplay=document.getElementById("pitch-timer"),this.accuracyDisplay=document.getElementById("pitch-accuracy"),this.bestStreakDisplay=document.getElementById("pitch-best-streak"),this.notesTrainedDisplay=document.getElementById("pitch-notes-trained"),this.volumeFill=document.getElementById("pitch-volume-fill"),this.guidanceDisplay=document.getElementById("pitch-guidance"),this.difficultySelect=document.getElementById("pitch-difficulty"),this.instrumentSelect=document.getElementById("instrument-select"),this.playTargetNoteButton=document.getElementById("play-target-note"),this.pitchGameSelect=document.getElementById("pitch-game-mode"),this.pitchGameCanvas=document.getElementById("pitch-game-canvas"),this.audioContext=null,this.analyser=null,this.microphone=null,this.mediaStream=null,this.isTraining=!1,this.targetNote=null,this.targetFrequency=0,this.score=0,this.streak=0,this.bestStreak=0,this.totalNotesTrained=0,this.matchesHit=0,this.gameTimer=null,this.timeLeft=60,this.noteMatchedTime=0,this.instrumentType="sine",this.detectFrameId=null,this.nextNoteTimeout=null,this.boundVisibilityHandler=null,this.boundUnloadHandler=null,this.pitchEngine=null,this.pitchGameMode="off",this.pitchArcadeStorageKey="pitchArcadeMode",this.noteFrequencies={C4:261.63,D4:293.66,E4:329.63,F4:349.23,G4:392,A4:440,B4:493.88,C5:523.25},this.difficultyRanges={easy:["C4","E4","G4","C5"],medium:["C4","D4","E4","F4","G4","A4","B4","C5"],hard:Object.keys(this.noteFrequencies)},this.init(),this.setupPitchArcade(),this.attachLifecycleHooks()}init(){this.startButton&&this.startButton.addEventListener("click",()=>this.start()),this.stopButton&&this.stopButton.addEventListener("click",()=>this.stop()),this.playTargetNoteButton&&this.playTargetNoteButton.addEventListener("click",()=>this.playTargetNote()),this.instrumentSelect&&(this.instrumentType=this.instrumentSelect.value,this.instrumentSelect.addEventListener("change",()=>{this.instrumentType=this.instrumentSelect.value}))}playInstrumentTone(t){if(!this.audioContext)return;const e=this.audioContext.createOscillator(),i=this.audioContext.createGain();e.connect(i),i.connect(this.audioContext.destination),e.type=this.instrumentType,e.frequency.setValueAtTime(t,this.audioContext.currentTime),i.gain.setValueAtTime(.3,this.audioContext.currentTime),i.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+1),e.start(),e.stop(this.audioContext.currentTime+1)}generateTargetNote(){const t=this.difficultySelect?this.difficultySelect.value:"easy",e=this.difficultyRanges[t],i=Math.floor(Math.random()*e.length);this.targetNote=e[i],this.targetFrequency=this.noteFrequencies[this.targetNote],this.targetNoteDisplay&&(this.targetNoteDisplay.textContent=`Target: ${this.targetNote}`),this.noteMatchedTime=0,this.totalNotesTrained++,this.notesTrainedDisplay&&(this.notesTrainedDisplay.textContent=this.totalNotesTrained),this.playTargetNote()}playTargetNote(){this.targetFrequency&&this.playInstrumentTone(this.targetFrequency)}updatePitchMeter(t,e){if(!this.targetFrequency||!this.pitchIndicator)return;const i=typeof e=="number"?e:1200*Math.log2(t/this.targetFrequency),s=Math.max(-50,Math.min(50,i));if(this.pitchIndicator.style.left=`calc(50% + ${s}%)`,Math.abs(i)<10?this.pitchIndicator.style.backgroundColor="#00ff00":Math.abs(i)<30?this.pitchIndicator.style.backgroundColor="#ffff00":this.pitchIndicator.style.backgroundColor="#ff0000",this.guidanceDisplay){const n=i>3?"Lower pitch slightly":i<-3?"Raise pitch slightly":"Right on pitch";this.guidanceDisplay.textContent=`${n} (Î” ${i.toFixed(1)}Â¢)`}}detectPitchLoop(){if(!this.isTraining||!this.analyser)return;const t=this.analyser.fftSize,e=new Float32Array(t);this.analyser.getFloatTimeDomainData(e);const i=Math.sqrt(e.reduce((c,l)=>c+l*l,0)/t);this.volumeFill&&(this.volumeFill.style.width=`${Math.min(100,Math.max(5,i*350))}%`);let s=0,n=-1;const h=this.audioContext.sampleRate;for(let c=40;c<t;c++){let l=0;for(let r=0;r<t-c;r++)l+=e[r]*e[r+c];l>s&&(s=l,n=c)}const o=n>0?h/n:0;if(o>100){const l=w(o,{minFrequency:80,maxFrequency:1500,maxCentError:80})?.note||"---";this.userNoteDisplay&&(this.userNoteDisplay.textContent=`You: ${l} (${o.toFixed(2)} Hz)`);const r=1200*Math.log2(o/this.targetFrequency);this.updatePitchMeter(o,r);const f=l===this.targetNote&&Math.abs(r)<15;if(this.updatePitchEngineSample({cents:r,onTarget:f,rms:i}),f){if(this.noteMatchedTime===0&&(this.noteMatchedTime=Date.now()),Date.now()-this.noteMatchedTime>500){if(this.feedbackMessage&&(this.feedbackMessage.textContent="âœ… Perfect Match!"),this.score+=10,this.streak++,this.matchesHit++,this.bestStreak=Math.max(this.bestStreak,this.streak),this.scoreDisplay&&(this.scoreDisplay.textContent=this.score),this.streakDisplay&&(this.streakDisplay.textContent=this.streak),this.bestStreakDisplay&&(this.bestStreakDisplay.textContent=this.bestStreak),this.accuracyDisplay){const y=this.totalNotesTrained>0?Math.round(this.matchesHit/this.totalNotesTrained*100):0;this.accuracyDisplay.textContent=`${y}%`}this.nextNoteTimeout&&clearTimeout(this.nextNoteTimeout),this.nextNoteTimeout=setTimeout(()=>this.generateTargetNote(),1e3)}}else this.noteMatchedTime=0,this.streak=0,this.streakDisplay&&(this.streakDisplay.textContent=this.streak),this.feedbackMessage&&(this.feedbackMessage.textContent="ðŸŽ¤ Keep trying!")}else this.userNoteDisplay&&(this.userNoteDisplay.textContent="You: ---"),this.guidanceDisplay&&(this.guidanceDisplay.textContent="Increase input volume or sing a clear note"),this.updatePitchEngineSample({cents:0,onTarget:!1,rms:i});const u=typeof window<"u"?window.requestAnimationFrame:null;this.isTraining&&u&&(this.detectFrameId=u(()=>this.detectPitchLoop()))}async start(){if(!this.isTraining)try{this.audioContext=v(),this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.microphone=this.audioContext.createMediaStreamSource(this.mediaStream),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=2048,this.microphone.connect(this.analyser),this.isTraining=!0,this.score=0,this.streak=0,this.timeLeft=60,this.startButton&&(this.startButton.disabled=!0),this.stopButton&&(this.stopButton.disabled=!1),this.scoreDisplay&&(this.scoreDisplay.textContent=this.score),this.streakDisplay&&(this.streakDisplay.textContent=this.streak),this.generateTargetNote(),this.gameTimer=setInterval(()=>{this.timeLeft--,this.timerDisplay&&(this.timerDisplay.textContent=`Time: ${this.timeLeft}s`),this.timeLeft<=0&&this.stop()},1e3),this.detectPitchLoop(),this.handleArcadeStart()}catch(t){this.feedbackMessage&&(this.feedbackMessage.textContent="âŒ Error: "+t.message),this.stop()}}stop(){this.nextNoteTimeout&&(clearTimeout(this.nextNoteTimeout),this.nextNoteTimeout=null),this.isTraining=!1,clearInterval(this.gameTimer),this.gameTimer=null,T(this.mediaStream),this.mediaStream=null,C(this.detectFrameId),this.detectFrameId=null,E(this.audioContext),this.audioContext=null,this.analyser=null,this.microphone=null,this.startButton&&(this.startButton.disabled=!1),this.stopButton&&(this.stopButton.disabled=!0),this.feedbackMessage&&(this.feedbackMessage.textContent=`Game Over! Final Score: ${this.score}`),this.targetNoteDisplay&&(this.targetNoteDisplay.textContent="Target: ---"),this.userNoteDisplay&&(this.userNoteDisplay.textContent="You: ---"),this.handleArcadeStop()}attachLifecycleHooks(){typeof document>"u"||this.boundVisibilityHandler||(this.boundVisibilityHandler=()=>{this.audioContext&&(document.hidden?this.audioContext.suspend?.():this.isTraining&&this.audioContext.resume?.())},document.addEventListener("visibilitychange",this.boundVisibilityHandler),this.boundUnloadHandler=()=>this.dispose(),window.addEventListener("beforeunload",this.boundUnloadHandler))}detachLifecycleHooks(){this.boundVisibilityHandler&&typeof document<"u"&&(document.removeEventListener("visibilitychange",this.boundVisibilityHandler),this.boundVisibilityHandler=null),this.boundUnloadHandler&&(window.removeEventListener("beforeunload",this.boundUnloadHandler),this.boundUnloadHandler=null)}dispose(){this.stop(),this.detachLifecycleHooks(),this.pitchEngine?.dispose?.(),this.pitchEngine=null}setupPitchArcade(){if(!this.pitchGameCanvas)return;try{this.pitchEngine=H(this.pitchGameCanvas),this.pitchEngine.addEventListener("scene-event",i=>this.handleSceneEvent(i))}catch(i){console.warn("Pitch arcade unavailable:",i),this.pitchEngine=null;return}const e=this.getStoredArcadeMode()||(this.pitchGameSelect?.value??"off");this.pitchGameSelect&&(this.pitchGameSelect.value=e,this.pitchGameSelect.addEventListener("change",i=>{this.setPitchGameMode(i.target.value)})),this.setPitchGameMode(e)}setPitchGameMode(t="off"){if(this.pitchGameMode=t,this.storeArcadeMode(t),!!this.pitchEngine){if(t==="off"){this.pitchEngine.setMode("off"),this.pitchEngine.pause(),this.togglePitchGameVisibility(!1);return}this.togglePitchGameVisibility(!0),this.pitchEngine.setMode(t),this.isTraining?this.pitchEngine.start():this.pitchEngine.pause()}}togglePitchGameVisibility(t){const e=this.pitchGameCanvas?.closest(".pitch-game");this.pitchGameCanvas&&(this.pitchGameCanvas.style.display=t?"block":"none"),e&&(e.style.opacity=t?"1":"0.4")}updatePitchEngineSample(t){!this.pitchEngine||this.pitchGameMode==="off"||this.pitchEngine.updatePitch(t)}handleArcadeStart(){!this.pitchEngine||this.pitchGameMode==="off"||this.pitchEngine.start()}handleArcadeStop(){this.pitchEngine&&this.pitchEngine.pause()}handleSceneEvent(t){this.lastSceneEvent=t}storeArcadeMode(t){if(!(typeof window>"u"||!window.localStorage))try{window.localStorage.setItem(this.pitchArcadeStorageKey,t)}catch(e){console.warn("Unable to persist arcade mode",e)}}getStoredArcadeMode(){if(typeof window>"u"||!window.localStorage)return null;try{return window.localStorage.getItem(this.pitchArcadeStorageKey)}catch(t){return console.warn("Unable to read arcade mode",t),null}}}document.addEventListener("DOMContentLoaded",()=>{new S().init(),new b,new R});
