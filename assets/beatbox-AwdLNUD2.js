import{N as l}from"./Navigation-Ct1b79JU.js";import{A as h}from"./AppInitializer-anmfjxeg.js";import{a as d}from"./AudioEngine-NqXvItqJ.js";class u{constructor(){this.sounds={},this.pads=document.querySelectorAll(".beatbox-pad"),this.padQueue=[],this.padAnimationTimeouts=new Map,this.boundKeyHandler=t=>this.handleKeyTrigger(t),this.keyMap={KeyA:"kick",KeyS:"snare",KeyD:"hihat",KeyF:"cymbal"},this.startBtn=document.getElementById("beatbox-start"),this.stopBtn=document.getElementById("beatbox-stop"),this.tempoSlider=document.getElementById("beatbox-tempo"),this.tempoValue=document.getElementById("beatbox-tempo-value"),this.patternSelect=document.getElementById("beatbox-pattern"),this.gridContainer=document.getElementById("beatbox-grid-steps"),this.gridInfo=document.getElementById("beatbox-grid-info"),this.randomizeBtn=document.getElementById("beatbox-randomize"),this.currentStep=0,this.isPlaying=!1,this.stepInterval=null,this.stepsPerBar=16,this.rows=["kick","snare","hihat","cymbal"],this.gridState=new Map,this.patterns=this.getPatternDefinitions(),this.storageKey="audiation-beatbox-state",this.activePattern="default",this.isRestoring=!1,this.init()}persistState(){if(typeof window>"u"||!window.localStorage)return;const t={pattern:this.activePattern,stepsPerBar:this.stepsPerBar,rows:this.rows.map(e=>({name:e,steps:Array.from({length:this.stepsPerBar},(i,s)=>this.gridState.get(`${e}-${s}`)?s:null).filter(i=>i!==null)}))};try{window.localStorage.setItem(this.storageKey,JSON.stringify(t))}catch(e){console.warn("Unable to persist beatbox state",e)}}loadState(){if(!(typeof window>"u"||!window.localStorage))try{const t=window.localStorage.getItem(this.storageKey);if(!t)return;const e=JSON.parse(t);if(!e?.rows)return;this.isRestoring=!0,this.applyPattern(e.pattern||"default"),this.gridState.clear(),this.gridContainer?.querySelectorAll(".grid-step").forEach(i=>i.classList.remove("active")),e.rows.forEach(i=>{i.steps?.forEach(s=>this.toggleGridStep(i.name,s,!0))})}catch(t){console.warn("Failed to load beatbox state",t)}finally{this.isRestoring=!1}}init(){this.setupPads(),this.attachKeyboardShortcuts(),this.buildGrid(),this.attachTransport(),this.applyPattern("default"),this.loadState()}async ensureAudioEngine(){d.isInitialized||await d.initialize(),d.resume(),this.sounds.kick||this.loadSounds()}setupPads(){this.pads.forEach((t,e)=>{const i=this.getSoundType(e),s=()=>{this.ensureAudioEngine().then(()=>this.playSound(i))};t.addEventListener("click",s),t.addEventListener("touchstart",n=>{n.preventDefault(),s()}),t.dataset.sound=i})}getSoundType(t){return["kick","snare","hihat","cymbal"][t]||"kick"}loadSounds(){this.sounds={kick:this.createKickSound(),snare:this.createSnareSound(),hihat:this.createHiHatSound(),cymbal:this.createCymbalSound()}}randomizeGrid(){this.isRestoring=!0,this.gridState.clear(),this.gridContainer?.querySelectorAll(".grid-step").forEach(e=>e.classList.remove("active"));const t={kick:.35,snare:.25,hihat:.5,cymbal:.2};this.rows.forEach(e=>{const i=t[e]??.3;for(let s=0;s<this.stepsPerBar;s++)Math.random()<i&&this.toggleGridStep(e,s,!0)}),this.isRestoring=!1,this.persistState(),this.gridInfo&&(this.gridInfo.textContent="Randomized Sacred Grid â€” tweak live with pads or keyboard.")}createKickSound(){return()=>{const t=d.getAudioContext(),e=t.createOscillator(),i=t.createGain();e.frequency.setValueAtTime(60,t.currentTime),e.frequency.exponentialRampToValueAtTime(.01,t.currentTime+.5),i.gain.setValueAtTime(1,t.currentTime),i.gain.exponentialRampToValueAtTime(.01,t.currentTime+.5),e.connect(i),i.connect(t.destination),e.start(),e.stop(t.currentTime+.5)}}createSnareSound(){return()=>{const t=d.getAudioContext(),e=t.sampleRate*.2,i=t.createBuffer(1,e,t.sampleRate),s=i.getChannelData(0);for(let r=0;r<e;r++)s[r]=(Math.random()*2-1)*Math.pow(1-r/e,2);const n=t.createBufferSource(),a=t.createGain();n.buffer=i,a.gain.setValueAtTime(.3,t.currentTime),a.gain.exponentialRampToValueAtTime(.01,t.currentTime+.2),n.connect(a),a.connect(t.destination),n.start()}}createHiHatSound(){return()=>{const t=d.getAudioContext(),e=t.sampleRate*.1,i=t.createBuffer(1,e,t.sampleRate),s=i.getChannelData(0);for(let o=0;o<e;o++)s[o]=(Math.random()*2-1)*Math.pow(1-o/e,3);const n=t.createBufferSource(),a=t.createGain(),r=t.createBiquadFilter();r.type="highpass",r.frequency.value=8e3,n.buffer=i,a.gain.setValueAtTime(.2,t.currentTime),a.gain.exponentialRampToValueAtTime(.01,t.currentTime+.1),n.connect(r),r.connect(a),a.connect(t.destination),n.start()}}createCymbalSound(){return()=>{const t=d.getAudioContext(),e=t.sampleRate*.5,i=t.createBuffer(1,e,t.sampleRate),s=i.getChannelData(0);for(let o=0;o<e;o++)s[o]=(Math.random()*2-1)*Math.pow(1-o/e,1.5);const n=t.createBufferSource(),a=t.createGain(),r=t.createBiquadFilter();r.type="bandpass",r.frequency.value=3e3,r.Q.value=1,n.buffer=i,a.gain.setValueAtTime(.1,t.currentTime),a.gain.exponentialRampToValueAtTime(.01,t.currentTime+.5),n.connect(r),r.connect(a),a.connect(t.destination),n.start()}}playSound(t){this.sounds[t]&&(this.sounds[t](),this.enqueuePadAnimation(t))}enqueuePadAnimation(t){const e=Array.from(this.pads).find(s=>s.dataset.sound===t);if(!e)return;this.padAnimationTimeouts.has(e)&&clearTimeout(this.padAnimationTimeouts.get(e)),e.style.transform="scale(0.95)",e.style.filter="brightness(1.5)";const i=setTimeout(()=>{e.style.transform="scale(1)",e.style.filter="brightness(1)",this.padAnimationTimeouts.delete(e)},120);this.padAnimationTimeouts.set(e,i)}attachKeyboardShortcuts(){window.addEventListener("keydown",this.boundKeyHandler)}handleKeyTrigger(t){const e=this.keyMap[t.code];e&&(t.preventDefault(),this.ensureAudioEngine().then(()=>{this.playSound(e),this.toggleGridStep(e,this.currentStep,!0)}))}buildGrid(){this.gridContainer&&(this.gridContainer.innerHTML="",this.rows.forEach(t=>{const e=document.createElement("div");e.className="grid-row";const i=document.createElement("div");i.className="grid-row-label",i.textContent=t;const s=document.createElement("div");s.className="grid-row-steps";for(let n=0;n<this.stepsPerBar;n++){const a=document.createElement("button");a.type="button",a.className="grid-step",a.dataset.row=t,a.dataset.step=n,a.addEventListener("click",()=>this.toggleGridStep(t,n)),s.appendChild(a)}e.appendChild(i),e.appendChild(s),this.gridContainer.appendChild(e)}))}toggleGridStep(t,e,i=null){const s=`${t}-${e}`,n=this.gridContainer?.querySelector(`.grid-step[data-row="${t}"][data-step="${e}"]`);if(!n)return;const a=i!==null?i:!this.gridState.get(s);this.gridState.set(s,a),n.classList.toggle("active",a),this.isRestoring||this.persistState()}attachTransport(){this.startBtn?.addEventListener("click",()=>this.startSequencer()),this.stopBtn?.addEventListener("click",()=>this.stopSequencer()),this.tempoSlider?.addEventListener("input",t=>{const e=Number(t.target.value);this.tempoValue&&(this.tempoValue.textContent=`${e} BPM`),this.isPlaying&&(this.stopSequencer(),this.startSequencer())}),this.patternSelect?.addEventListener("change",t=>{this.applyPattern(t.target.value)}),this.randomizeBtn?.addEventListener("click",()=>this.randomizeGrid())}async startSequencer(){if(this.isPlaying)return;await this.ensureAudioEngine(),this.isPlaying=!0,this.currentStep=0;const e=6e4/Number(this.tempoSlider?.value||108)/4;this.stepInterval=setInterval(()=>this.advanceStep(),e),this.startBtn&&(this.startBtn.disabled=!0),this.stopBtn&&(this.stopBtn.disabled=!1)}stopSequencer(){this.isPlaying&&(this.isPlaying=!1,clearInterval(this.stepInterval),this.stepInterval=null,this.clearPlayhead(),this.startBtn&&(this.startBtn.disabled=!1),this.stopBtn&&(this.stopBtn.disabled=!0))}advanceStep(){this.clearPlayhead(),this.rows.forEach(t=>{const e=`${t}-${this.currentStep}`;this.gridState.get(e)&&this.playSound(t),this.gridContainer?.querySelector(`.grid-step[data-row="${t}"][data-step="${this.currentStep}"]`)?.classList.add("playhead")}),this.currentStep=(this.currentStep+1)%this.stepsPerBar}clearPlayhead(){this.gridContainer?.querySelectorAll(".grid-step.playhead").forEach(t=>t.classList.remove("playhead"))}applyPattern(t){const e=this.patterns[t]||this.patterns.default;this.activePattern=t in this.patterns?t:"default",this.gridState.clear(),this.gridContainer?.querySelectorAll(".grid-step").forEach(i=>i.classList.remove("active")),this.rows.forEach((i,s)=>{(e.steps[s]||[]).forEach(a=>this.toggleGridStep(i,a,!0))}),this.gridInfo&&(this.gridInfo.textContent=e.description),this.isRestoring||this.persistState()}getPatternDefinitions(){return{default:{steps:[[0,4,8,12],[4,12],[2,6,10,14],[0,8]],description:"Balanced 4/4 grid with kick on quarters and hats on the off-beats."},fibonacci:{steps:[[0,1,3,5,8,13],[5,8,13],[2,3,5,8,13],[1,4,7,11,14]],description:"Fibonacci spacing to create expanding syncopation (1-1-2-3-5-8)."},trinity:{steps:[[0,8],[4,12],[2,6,10,14],[3,9,15]],description:"3:2 polyrhythm where hi-hats trace triplets over duple kicks."},golden:{steps:[[0,7,11],[3,9,14],[2,5,8,13],[1,4,6,10,12,15]],description:"Golden ratio accents: 0/0.618/1 overlays for evolving shimmer."}}}dispose(){this.padAnimationTimeouts.forEach(t=>clearTimeout(t)),this.padAnimationTimeouts.clear(),window.removeEventListener("keydown",this.boundKeyHandler),this.stopSequencer()}}document.addEventListener("DOMContentLoaded",()=>{new h().init(),new l,new u});
